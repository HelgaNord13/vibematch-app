<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>Vibe Match</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <!-- Telegram WebApp -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>

    <!-- WebRTC -->
    <script src="https://cdn.jsdelivr.net/npm/simple-peer@9/simplepeer.min.js"></script>

    <style>
      body {
        font-family: -apple-system, BlinkMacSystemFont, sans-serif;
        padding: 20px;
        background-color: #ffffff;
        color: #000000;
      }

      h1 {
        text-align: center;
        margin-bottom: 20px;
      }

      p {
        font-size: 16px;
        line-height: 1.4;
      }

      button {
        background-color: #007bff;
        color: #ffffff;
        border: none;
        border-radius: 10px;
        padding: 14px;
        width: 100%;
        margin: 8px 0;
        cursor: pointer;
        font-size: 16px;
      }

      button:hover {
        background-color: #0056b3;
      }

      .user-card {
        border: 1px solid #ddd;
        padding: 12px;
        margin: 10px 0;
        border-radius: 10px;
      }

      video {
        width: 100%;
        margin-top: 12px;
        border-radius: 10px;
        background: #000;
      }
    </style>
  </head>

  <body>
    <h1>Vibe Match</h1>
    <div id="app">Загрузка…</div>

    <script>
      const tg = window.Telegram.WebApp;
      tg.ready();
      const user = tg.initDataUnsafe?.user;

      /* ================= АНКЕТА ================= */

      const questions = [
        {
          id: "gender",
          text: "Как ты себя идентифицируешь?",
          options: [
            { text: "Мужчина", value: "man" },
            { text: "Женщина", value: "woman" },
            { text: "Небинарная персона", value: "nonbinary" },
            { text: "Предпочитаю не указывать", value: "na" }
          ]
        },
        {
          id: "age",
          text: "Твой возраст",
          options: [
            { text: "До 20", value: "under20" },
            { text: "21–25", value: "21-25" },
            { text: "26–30", value: "26-30" },
            { text: "31–35", value: "31-35" },
            { text: "36–45", value: "36-45" },
            { text: "46+", value: "46+" }
          ]
        },
        {
          id: "goal",
          text: "Что тебе сейчас ближе?",
          options: [
            { text: "Дружеское общение", value: "friendship" },
            { text: "Лёгкие свидания без давления", value: "dating" },
            { text: "Отношения и близость", value: "relationship" }
          ]
        },
        {
          id: "lookingFor",
          text: "С кем тебе комфортнее искать совпадение по вайбу?",
          multiple: true,
          options: [
            { text: "С мужчинами", value: "man" },
            { text: "С женщинами", value: "woman" },
            { text: "С небинарными персонами", value: "nonbinary" },
            { text: "Гендер не имеет значения", value: "any" }
          ]
        },
        {
          id: "depth",
          text: "Тебе важнее глубина или лёгкость?",
          options: [
            { text: "Глубина", value: 7 },
            { text: "Лёгкость", value: 3 }
          ]
        },
        {
          id: "freedom",
          text: "Свобода для тебя — это…",
          options: [
            { text: "Делать, что чувствую", value: 7 },
            { text: "Иметь стабильность", value: 3 }
          ]
        },
        {
          id: "ambition",
          text: "Тебя больше тянет к…",
          options: [
            { text: "Большим целям", value: 7 },
            { text: "Спокойной жизни", value: 3 }
          ]
        }
      ];

      let current = 0;
      let answers = JSON.parse(localStorage.getItem("vibe_answers")) || {};
      let multiBuffer = [];

      if (Object.keys(answers).length === 0) {
        renderQuestion();
      } else {
        showSearchScreen();
      }

      function renderQuestion() {
        const q = questions[current];
        let html = `<p><b>${q.text}</b></p>`;

        q.options.forEach(o => {
          html += `<button onclick="selectAnswer('${q.id}','${o.value}', ${q.multiple || false})">${o.text}</button>`;
        });

        if (q.multiple) {
          html += `<button onclick="confirmMulti()">Продолжить</button>`;
        }

        document.getElementById("app").innerHTML = html;
      }

      function selectAnswer(id, value, multiple) {
        if (multiple) {
          if (!multiBuffer.includes(value)) multiBuffer.push(value);
        } else {
          answers[id] = value;
          current++;
          renderNext();
        }
      }

      function confirmMulti() {
        answers[questions[current].id] = multiBuffer;
        multiBuffer = [];
        current++;
        renderNext();
      }

      function renderNext() {
        if (current < questions.length) {
          renderQuestion();
        } else {
          localStorage.setItem("vibe_answers", JSON.stringify(answers));
          showSearchScreen();
        }
      }

      function showSearchScreen() {
        document.getElementById("app").innerHTML = `
          <p><b>Анкета заполнена</b></p>
          <p>Подбираем людей с похожим вайбом…</p>
          <button onclick="startMatching()">Найти вайб</button>
        `;
      }

      /* ================= SIGNAL SERVER ================= */

      const ws = new WebSocket("ws://YOUR_PUBLIC_IP:8080"); // ЗАМЕНИ НА IP / ДОМЕН

      let activeUsers = [];
      const peerMap = {};

      ws.onopen = () => {
        ws.send(JSON.stringify({
          type: "join",
          user: { id: user.id, name: user.first_name }
        }));
      };

      ws.onmessage = msg => {
        const data = JSON.parse(msg.data);

        if (data.type === "update_users") {
          activeUsers = data.users.filter(u => u.id !== user.id);
        }

        if (data.type === "signal" && peerMap[data.from]) {
          peerMap[data.from].signal(data.signal);
        }
      };

      function startMatching() {
        const container = document.createElement("div");
        container.innerHTML = "<p><b>Доступные пользователи:</b></p>";

        if (activeUsers.length === 0) {
          container.innerHTML += "<p>Пока нет подключённых пользователей. Подождите…</p>";
        }

        activeUsers.forEach(u => {
          const div = document.createElement("div");
          div.className = "user-card";
          div.innerHTML = `
            <p><b>${u.name}</b></p>
            <button onclick="startCall(${u.id}, '${u.name}')">Позвонить</button>
          `;
          container.appendChild(div);
        });

        document.getElementById("app").innerHTML = "";
        document.getElementById("app").appendChild(container);
      }

      function startCall(peerId, name) {
        document.getElementById("app").innerHTML = `
          <p><b>Созвон с ${name}</b></p>
          <video id="localVideo" autoplay muted></video>
          <video id="remoteVideo" autoplay></video>
        `;

        navigator.mediaDevices.getUserMedia({ video: true, audio: true }).then(stream => {
          document.getElementById("localVideo").srcObject = stream;

          const peer = new SimplePeer({
            initiator: true,
            trickle: false,
            stream
          });

          peerMap[peerId] = peer;

          peer.on("signal", signal => {
            ws.send(JSON.stringify({
              type: "signal",
              from: user.id,
              to: peerId,
              signal
            }));
          });

          peer.on("stream", remote => {
            document.getElementById("remoteVideo").srcObject = remote;
          });
        });
      }
    </script>
  </body>
</html>


// === ADMIN RESET (ТОЛЬКО ДЛЯ ТЕСТОВ) ===
const ADMIN_IDS = [316151714]; //

if (ADMIN_IDS.includes(user?.id)) {
  const resetBtn = document.createElement("button");
  resetBtn.innerText = "⚠️ Сбросить анкету (админ)";
  resetBtn.style.background = "#dc3545";
  resetBtn.onclick = () => {
    localStorage.removeItem("vibe_answers");
    location.reload();
  };
  document.body.appendChild(resetBtn);
}

