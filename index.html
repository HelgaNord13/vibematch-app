<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>Vibe App</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/simple-peer@9/simplepeer.min.js"></script>
    <style>
      body {
        font-family: sans-serif;
        padding: 20px;
        background-color: #ffffff;
        color: #000000;
      }

      h1 {
        text-align: center;
        margin-bottom: 20px;
      }

      button {
        background-color: #007bff;
        color: #ffffff;
        border: none;
        border-radius: 8px;
        padding: 12px;
        width: 100%;
        margin: 8px 0;
        cursor: pointer;
        font-size: 16px;
      }

      button:hover {
        background-color: #0056b3;
      }

      .user-card {
        border: 1px solid #ccc;
        padding: 10px;
        margin: 8px 0;
        border-radius: 8px;
      }

      video {
        width: 100%;
        margin-top: 10px;
        border-radius: 8px;
        background-color: #000;
      }
    </style>
  </head>

  <body>
    <h1>Vibe Match</h1>
    <div id="app">Загрузка…</div>

    <script>
      const tg = window.Telegram.WebApp;
      tg.ready();
      const user = tg.initDataUnsafe?.user;

      const questions = [
        { id: "depth", text: "Тебе важнее глубина или лёгкость?", options:[{text:"Глубина",value:7},{text:"Лёгкость",value:3}] },
        { id: "freedom", text: "Свобода для тебя — это…", options:[{text:"Делать, что чувствую",value:7},{text:"Иметь стабильность",value:3}] },
        { id: "ambition", text: "Тебя больше тянет к…", options:[{text:"Большим целям",value:7},{text:"Спокойной жизни",value:3}] }
      ];

      let current = 0;
      let answers = JSON.parse(localStorage.getItem("vibe_answers")) || {};
      let activeUsers = [];

      if(Object.keys(answers).length === 0) renderQuestion();
      else showSearchScreen();

      function renderQuestion(){
        const q = questions[current];
        document.getElementById("app").innerHTML = `
          <p><b>${q.text}</b></p>
          ${q.options.map(o=>`<button onclick="answer('${o.id}',${o.value})">${o.text}</button>`).join("")}
        `;
      }

      function answer(id,value){
        answers[id]=value;
        current++;
        if(current<questions.length) renderQuestion();
        else { 
          localStorage.setItem("vibe_answers", JSON.stringify(answers));
          showSearchScreen();
        }
      }

      function showSearchScreen(){
        document.getElementById("app").innerHTML=`
          <p><b>Анкета заполнена</b></p>
          <p>Ищем людей с похожим вайбом…</p>
          <button onclick="startMatching()">Найти вайб</button>
        `;
      }

      // Signal сервер
      const ws = new WebSocket("ws://YOUR_PUBLIC_IP:8080"); // <- замени на IP/VPS
      ws.onopen = () => {
        ws.send(JSON.stringify({ type:"join", user: {id:user.id, name:user.first_name} }));
      };

      ws.onmessage = (msg) => {
        const data = JSON.parse(msg.data);

        if(data.type==="update_users"){
          activeUsers = data.users.filter(u=>u.id !== user.id);
        }

        if(data.type==="signal" && data.to === user.id){
          if(peerMap[data.from]){
            peerMap[data.from].signal(data.signal);
          }
        }
      };

      const peerMap = {};

      function startMatching(){
        document.getElementById("app").innerHTML=`<p><b>Доступные пользователи для звонка:</b></p><div id="matches"></div>`;
        const container=document.getElementById("matches");

        if(activeUsers.length===0){
          container.innerHTML="<p>Пока нет подключённых пользователей. Подождите…</p>";
          return;
        }

        activeUsers.forEach(o=>{
          const div=document.createElement("div");
          div.className="user-card";
          div.innerHTML=`
            <p><b>${o.name}</b></p>
            <button onclick="startCall(${o.id},'${o.name}')">Позвонить</button>
          `;
          container.appendChild(div);
        });
      }

      function startCall(peerId, peerName){
        document.getElementById("app").innerHTML=`
          <p><b>Созвон с ${peerName}…</b></p>
          <video id="localVideo" autoplay muted></video>
          <video id="remoteVideo" autoplay></video>
        `;

        navigator.mediaDevices.getUserMedia({video:true,audio:true}).then(stream=>{
          document.getElementById("localVideo").srcObject = stream;

          const peer = new SimplePeer({initiator:true,trickle:false,stream:stream});
          peerMap[peerId] = peer;

          peer.on('signal', signal => {
            ws.send(JSON.stringify({ type:"signal", signal, from:user.id, to:peerId }));
          });

          peer.on('stream', remoteStream => {
            document.getElementById("remoteVideo").srcObject = remoteStream;
          });
        });
      }
    </script>
  </body>
</html>
